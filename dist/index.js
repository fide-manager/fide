import{app,BrowserWindow,protocol,net,ipcMain,Notification,Menu,dialog}from"electron";import pkg from"electron-updater";let autoUpdater=pkg.autoUpdater;import path from"path";import io from"socket.io-client";import scriptrun from"./scriptrun.js";import fs from"fs";import*as d3 from"d3";let listener_inited={},isDev="development"===process.env.NODE_ENV,windows=(protocol.registerSchemesAsPrivileged([{scheme:"app",privileges:{standard:!0,supportFetchAPI:!0,secure:!0}}]),process.env.ELECTRON_DISABLE_SECURITY_WARNINGS="true",{}),logpath=(app.setAppLogsPath(),app.getPath("logs")),createMainWindow=()=>{windows.main=new BrowserWindow({width:1280,height:900,titleBarStyle:"hidden",minWidth:1080,minHeight:720,title:"Fide",show:!1,webPreferences:{preload:path.join(app.getAppPath(),"/dist/preload.js")}}),windows.main.loadURL(isDev?"http://localhost:3000":"https://app.fide.co.kr:3001"),windows.main.on("maximize",()=>{windows.main.webContents.send("maximized",!0)}),windows.main.on("unmaximize",()=>{windows.main.webContents.send("maximized",!1)}),windows.main.on("minimize",()=>{}),windows.main.on("restore",()=>{}),ipcMain.on("minimize",(e,t)=>{windows.main.minimize()}),ipcMain.on("maximize",(e,t)=>{windows.main.maximize()}),ipcMain.on("unmaximize",(e,t)=>{windows.main.unmaximize()}),ipcMain.on("close",(e,t)=>{windows.main.close()}),ipcMain.handle("loaded",()=>(windows.main.show(),{isDev:isDev}));let F=new scriptrun,t={},p=(F.on("meta",e=>t[e.coin]=e),setInterval(()=>windows.main.webContents.send("meta",t),1e3),F.on("calculated",e=>windows.main.webContents.send("calculated",e)),F.on("blocked",e=>windows.main.webContents.send("log",{type:"blocked",...e})),F.on("order",e=>windows.main.webContents.send("log",{type:"order",...e})),F.on("stopped",e=>{windows.main.webContents.send("run",!1),windows.main.webContents.send("error",e)}),{}),d,b={},g,x={},i={},$,m={},h=(setInterval(()=>{windows.main.webContents.send("accounts",m),m={}},1e3),F.on("account",e=>{let t=new Date(e.updatedAt).getTime();var{currency:a,balance:i,locked:o}=e,n=i+o;let s=e.avg_buy_price,r=e.totalValue,c=e.avg_buy_price*n;"KRW"==a&&(s=1,r=i+o,c=r),!$||(e=p?.[$]?.[a]?.[p?.[$]?.[a]?.length-1])&&e.amount==n||(p[$][a]||(p[$][a]=[]),p[$][a].find(e=>e.timestamp==t))||(p[$][a].push({amount:n,avg_buy_price:s,total_value:r,total_buy:c,timestamp:t}),console.log(a,n,s,r,c,t),fs.appendFileSync(d,`
${a},${n},${s},${r.toFixed(2)},${c},`+t),m[a]||(m[a]=[]),m[a].push({coin:a,amount:n,avg_buy_price:s,total_value:Number(r.toFixed(2)),total_buy:c,timestamp:t}))}),F.on("action",e=>{let{coin:t,type:a,action:i,avg_buy_price:o,income_rate:n,trade_price:s,amount:r,data:{"이동평균":c,RSI:p,MACD:d,"거래량변동":m,ATR:l,"볼린저밴드":u,CCI:w,ADX:_,"피봇포인트":h},timestamp:v}=e;if($){if(b[$][t]||(b[$][t]=[]),b[$][t].find(e=>e.timestamp==v))return;b[$][t].push({type:a,action:i,avg_buy_price:o,income_rate:n,trade_price:s,amount:r,ma:c,rsi:p,macd:d,cv:m,atr:l,bb:u,cci:w,adx:_,pivot:h,timestamp:v}),fs.appendFileSync(g,`
${t},${a},${i},${o.toFixed(2)},${(100*n).toFixed(2)},${s},${r},${c},${p},${d},${m},${l},${u},${w},${_},${h},`+v),windows.main.webContents.send("action_history",{coin:t,type:a,action:i,avg_buy_price:o,income_rate:n,trade_price:s,amount:r,ma:c,rsi:p,macd:d,cv:m,atr:l,bb:u,cci:w,adx:_,pivot:h,timestamp:v})}windows.main.webContents.send("action",e)}),{});let y=e=>{var t=x[$],a=x[$][e],i=a[a.length-1];let o=[],n=[],s=(Object.values(t).forEach(e=>{0<e.length&&(o.push(e[0]),n.push(e[e.length-1]))}),(new Date).getTime()-864e5),r=(new Date).getTime();var c=F.setting;l={"이동평균":(t=c).score_ma,RSI:t.score_rsi,MACD:t.score_macd,"거래량변동":t.score_cv,"볼린저밴드":t.score_bb,CCI:t.score_cci,ADX:t.score_adx,ATR:t.score_atr,"피봇포인트":Math.max(t.score_pivot,t.score_pivot_r1,t.score_pivot_r2)},t={"이동평균":-t.score_ma,RSI:-t.score_rsi,MACD:-t.score_macd,"거래량변동":-t.score_cv,"볼린저밴드":-t.score_bb,CCI:-t.score_cci,ADX:-t.score_adx,ATR:-t.score_atr,"피봇포인트":Math.min(t.score_pivot,t.score_pivot_s1,t.score_pivot_s2)};let{maxTotalScore:p,minTotalScore:d}={maxTotalScore:Object.values(l).reduce((e,t)=>e+t,0),minTotalScore:Object.values(t).reduce((e,t)=>e+t,0)},m=d3.line().x(e=>(parseInt(e.timestamp)-s)/(r-s)*600).y(e=>300*(1-(parseFloat(e.total_score||0)-d)/(p-d)));var l=a.filter(e=>parseInt(e.timestamp)>s).sort((e,t)=>e.timestamp-t.timestamp).reduce((e,t)=>{var a=new Date(parseInt(t.timestamp)),a=(a.setMinutes(5*Math.floor(a.getMinutes()/5)),a.setSeconds(0),a.setMilliseconds(0),a.getTime());return e[a]||(e[a]=t),e},{}),t=Object.values(l).reduce((e,t,a,i)=>{var o;return 0===a?e.push([t]):(a=e[e.length-1],o=parseInt(a[a.length-1].timestamp),6e5<parseInt(t.timestamp)-o?e.push([t]):a.push(t)),e},[]),a=t.map(e=>m(e)),u=m([{timestamp:s,total_score:0},{timestamp:r,total_score:0}]),w=300*(1-(0-d)/(p-d));let _=c.strategy_manual;switch(c.strategy_type){case"높음":_=c.strategy_high;break;case"중간":_=c.strategy_mid;break;case"낮음":_=c.strategy_low}var h=300*(1-(_-d)/(p-d)),v=m([{timestamp:s,total_score:_},{timestamp:r,total_score:_}]);let b=Math.max(...Object.values(l).map(e=>e.trade_price)),g=Math.min(...Object.values(l).map(e=>e.trade_price)),y=Math.ceil((b-(b+g)/2)/((b+g)/2)*100);y<5&&(y=5);l=(b+g)/2;b=l*(1+y/100),g=l*(1-y/100);let f=d3.line().x(e=>(parseInt(e.timestamp)-s)/(r-s)*600).y(e=>300*(1-(e.trade_price-g)/(b-g)));l=t.map(e=>f(e));windows.main.webContents.send("scoredata",{coin:e,lastscore:i,timestamp:i.timestamp,tradepricepath:l,pathData:a,zeroHeight:w,zeroline:u,buyscore:_,buyHeight:h,buyline:v,tradepricegap:y,minTimestamp:s,maxTimestamp:r,data:t.reduce((e,t)=>e.concat(t),[]),unitsize:288})};F.on("score",t=>{var e,a;x[$]||(x[$]={}),x[$][t.coin]||(x[$][t.coin]=[]),x[$][t.coin].find(e=>e.timestamp==t.timestamp)||(i[t.coin]=path.join(logpath,`fide_score_${$}_${t.coin}.log`),fs.existsSync(i[t.coin])||fs.writeFileSync(i[t.coin],"trade_price,total_buy,income_rate,ma,rsi,macd,cv,atr,bb,cci,adx,pivot,timestamp"),e={total_score:0===parseFloat(t.total_score.toFixed(2))?"0":t.total_score.toFixed(2),ma:0===parseFloat(t.ma.toFixed(2))?"0":t.ma.toFixed(2),rsi:0===parseFloat(t.rsi.toFixed(2))?"0":t.rsi.toFixed(2),macd:0===parseFloat(t.macd.toFixed(2))?"0":t.macd.toFixed(2),cv:0===parseFloat(t.cv.toFixed(2))?"0":t.cv.toFixed(2),atr:0===parseFloat(t.atr.toFixed(2))?"0":t.atr.toFixed(2),bb:0===parseFloat(t.bb.toFixed(2))?"0":t.bb.toFixed(2),cci:0===parseFloat(t.cci.toFixed(2))?"0":t.cci.toFixed(2),adx:0===parseFloat(t.adx.toFixed(2))?"0":t.adx.toFixed(2),pivot:0===parseFloat(t.pivot.toFixed(2))?"0":t.pivot.toFixed(2)},(a=x?.[$]?.[t.coin]?.[x?.[$]?.[t.coin]?.length-1])&&a.trade_price==t.trade_price&&a.total_buy==t.total_buy&&a.income_rate==t.income_rate&&a.ma==e.ma&&a.rsi==e.rsi&&a.macd==e.macd&&a.cv==e.cv&&a.atr==e.atr&&a.bb==e.bb&&a.cci==e.cci&&a.adx==e.adx&&a.pivot==e.pivot)||(fs.appendFileSync(i[t.coin],`
${t.trade_price},${t.total_buy},${0===parseFloat((100*t.income_rate).toFixed(2))?"0":(100*t.income_rate).toFixed(2)},${e.ma},${e.rsi},${e.macd},${e.cv},${e.atr},${e.bb},${e.cci},${e.adx},${e.pivot},${t.timestamp},`+t.total_score),x[$][t.coin].push({...t,...e}),h[t.coin]&&clearTimeout(h[t.coin]),h[t.coin]=setTimeout(()=>{y(t.coin)},1e3))}),F.on("candles",e=>{}),ipcMain.on("run",(e,t)=>{F.run(t),windows.main.webContents.send("run",t)}),ipcMain.on("setting",(e,t)=>{F.updateSetting(t)}),ipcMain.on("update_setting",(e,{key:t,value:a})=>{o&&o.emit("update_setting",{key:t,value:a})}),ipcMain.on("firstpromotion",(e,t)=>{o&&o.emit("firstpromotion",t)}),ipcMain.on("term",(e,{term:t,version:a,agree:i})=>{o&&o.emit("term",{term:t,version:a,agree:i})}),ipcMain.handle("save_setting",async(e,t)=>{let{promise:a,resolve:i,reject:o}=Promise.withResolvers();return dialog.showSaveDialog(null,{title:"설정 파일 내보내기",buttonLabel:"저장하기",filters:[{name:"json",extensions:["json"]}]}).then(({filePath:e})=>{fs.writeFileSync(e,t,"utf-8"),i(!0)}).catch(e=>{o(e)}),a}),ipcMain.handle("load_setting",async(e,t)=>{let{promise:a,resolve:i,reject:o}=Promise.withResolvers();return dialog.showOpenDialog({title:"설정 파일 불러오기",filters:[{name:"json",extensions:["json"]}],properties:["openFile"]}).then(({filePaths:e})=>{e=fs.readFileSync(e[0],"utf8");i(e)}).catch(e=>{o(e)}),a});let o;ipcMain.handle("activate_license_token",async(e,t)=>{let{promise:a,resolve:i}=Promise.withResolvers();return o?(o.emit("activate_license_token",t,e=>{i(e)}),a):{type:"error",data:"Socket not connected"}}),ipcMain.handle("auth",async(e,a)=>new Promise((e,t)=>{o?.accessToken==a?e(!0):(o&&o.disconnect(),(o=io(isDev?"http://localhost:8887":"https://app.fide.co.kr:8888",{auth:{token:a}})).accessToken=a,o.on("connect_error",e=>{t(!1)}),o.on("connect",()=>{e(!0)}),o.on("version",e=>{windows.main.webContents.send("version",e)}),o.on("terms",e=>{F.terms=e,windows.main.webContents.send("terms",e)}),o.on("license",e=>{if(e.uid){let v=e.uid;d=path.join(logpath,`fide_account_${v}.log`),fs.existsSync(d)||fs.writeFileSync(d,"coin,amount,avg_buy_price,total_value,total_buy,timestamp");var t=fs.readFileSync(d,"utf8"),t=(p[v]={},t.split("\n").slice(1).forEach(e=>{var[e,t,a,i,o,n]=e.split(",");p[v][e]||(p[v][e]=[]),p[v][e].push({amount:t,avg_buy_price:a,total_value:i,total_buy:o,timestamp:n}),m[e]||(m[e]=[]),m[e].push({coin:e,amount:t,avg_buy_price:a,total_value:i,total_buy:o,timestamp:n})}),g=path.join(logpath,`fide_action_${v}.log`),fs.existsSync(g)||fs.writeFileSync(g,"coin,type,action,avg_buy_price,income_rate,trade_price,amount,ma,rsi,macd,cv,atr,bb,cci,adx,pivot,timestamp"),fs.readFileSync(g,"utf8"));b[v]={},t.split("\n").slice(1).forEach(e=>{var[e,t,a,i,o,n,s,r,c,p,d,m,l,u,w,_,h]=e.split(",");b[v][e]||(b[v][e]=[]),b[v][e].push({type:t,action:a,avg_buy_price:i,income_rate:o,trade_price:n,amount:s,ma:r,rsi:c,macd:p,cv:d,atr:m,bb:l,cci:u,adx:w,pivot:_,timestamp:h}),windows.main.webContents.send("action_history",{coin:e,type:t,action:a,avg_buy_price:i,income_rate:o,trade_price:n,amount:s,ma:r,rsi:c,macd:p,cv:d,atr:m,bb:l,cci:u,adx:w,pivot:_,timestamp:h})});fs.readdirSync(logpath).filter(e=>e.includes(`fide_score_${v}_`)).forEach(e=>{var t=fs.readFileSync(path.join(logpath,e),"utf8");let _=e.split("_")[3].split(".")[0];x[v]||(x[v]={}),t.split("\n").slice(1).forEach(e=>{let[t,a,i,o,n,s,r,c,p,d,m,l,u,w]=e.split(",");x[v][_]||(x[v][_]=[]),isNaN(w)&&(w=0,w=(w=(w=(w=(w=(w=(w=(w=(w+=parseFloat(o||0))+parseFloat(n||0))+parseFloat(s||0))+parseFloat(r||0))+parseFloat(c||0))+parseFloat(p||0))+parseFloat(d||0))+parseFloat(m||0))+parseFloat(l||0)),w=parseFloat(w),x[v][_].push({trade_price:t,total_buy:a,income_rate:i,ma:o,rsi:n,macd:s,cv:r,atr:c,bb:p,cci:d,adx:m,pivot:l,timestamp:u,total_score:w}),h[_]&&clearTimeout(h[_]),h[_]=setTimeout(()=>{y(_)},1e3)})}),$=v}F.license=e,windows.main.webContents.send("license",e)}),o.on("setting",e=>{windows.main.webContents.send("setting",e)}))}))},updateready=(autoUpdater.on("checking-for-update",()=>{windows.main.webContents.send("checking-for-update",!0)}),autoUpdater.on("update-available",e=>{windows.main.webContents.send("update-available",e)}),autoUpdater.on("update-not-available",e=>{windows.main.webContents.send("update-not-available",e)}),autoUpdater.on("error",e=>{windows.main.webContents.send("update-error",e)}),autoUpdater.on("download-progress",e=>{windows.main.webContents.send("download-progress",e)}),!1);autoUpdater.on("update-downloaded",e=>{updateready=!0,windows.main.webContents.send("update-downloaded",e)}),ipcMain.on("update_install",()=>{updateready?autoUpdater.quitAndInstall():(app.relaunch(),app.exit(0))}),app.whenReady().then(()=>{protocol.handle("app",e=>net.fetch("file://"+path.join(app.getAppPath(),e.url.slice("app://".length)))),createMainWindow(),autoUpdater.checkForUpdatesAndNotify(new Notification({title:"Fide",body:"새 버전 다운로드가 완료되었습니다!"}))}),app.on("window-all-closed",()=>{"darwin"!==process.platform&&app.quit()}),app.on("activate",()=>{0===BrowserWindow.getAllWindows().length&&createMainWindow()}),app.requestSingleInstanceLock()?app.on("second-instance",(e,t,a)=>{windows.main&&(windows.main.isMinimized()&&windows.main.restore(),windows.main.focus())}):app.quit(),"win32"===process.platform&&app.setAppUserModelId("Fide");