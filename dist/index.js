import{app,BrowserWindow,protocol,net,ipcMain,Notification,Menu,dialog,shell}from"electron";import pkg from"electron-updater";let autoUpdater=pkg.autoUpdater;import path from"path";import io from"socket.io-client";import scriptrun from"./scriptrun.js";import fs from"fs";import*as d3 from"d3";let listener_inited={},isDev="development"===process.env.NODE_ENV,windows=(isDev||Menu.setApplicationMenu(!1),protocol.registerSchemesAsPrivileged([{scheme:"app",privileges:{standard:!0,supportFetchAPI:!0,secure:!0}}]),process.env.ELECTRON_DISABLE_SECURITY_WARNINGS="true",{}),logpath=(app.setAppLogsPath(),app.getPath("logs")),createMainWindow=()=>{windows.main=new BrowserWindow({width:1280,height:900,titleBarStyle:"hidden",minWidth:1080,minHeight:720,title:"Fide",show:!1,webPreferences:{preload:path.join(app.getAppPath(),"/dist/preload.js")}}),windows.main.loadURL(isDev?"http://localhost:3000":"https://app.fide.co.kr:3001"),windows.main.on("maximize",()=>{windows.main.webContents.send("maximized",!0)}),windows.main.on("unmaximize",()=>{windows.main.webContents.send("maximized",!1)}),windows.main.on("minimize",()=>{}),windows.main.on("restore",()=>{}),ipcMain.on("minimize",(e,t)=>{windows.main.minimize()}),ipcMain.on("maximize",(e,t)=>{windows.main.maximize()}),ipcMain.on("unmaximize",(e,t)=>{windows.main.unmaximize()}),ipcMain.on("close",(e,t)=>{windows.main.close()}),ipcMain.handle("loaded",()=>(windows.main.show(),{isDev:isDev}));let F=new scriptrun,t={},p=(F.on("meta",e=>t[e.coin]=e),setInterval(()=>windows.main.webContents.send("meta",t),1e3),F.on("calculated",e=>windows.main.webContents.send("calculated",e)),F.on("blocked",e=>windows.main.webContents.send("log",{type:"blocked",...e})),F.on("order",e=>windows.main.webContents.send("log",{type:"order",...e})),F.on("stopped",e=>{windows.main.webContents.send("run",!1),windows.main.webContents.send("error",e)}),{}),d,b={},g,x={},i={},M,l={},h=(setInterval(()=>{try{windows.main.webContents.send("accounts",l),l={}}catch(e){}},1e3),F.on("account",e=>{let t=(e.updatedAt?new Date(e.updatedAt):new Date).getTime();var{currency:a,balance:i,locked:o}=e,n=i+o;let s=e.avg_buy_price,r=e.totalValue,c=e.avg_buy_price*n;"KRW"==a&&(s=1,r=i+o,c=r),!M||(e=p?.[M]?.[a]?.[p?.[M]?.[a]?.length-1])&&e.amount==n||(p[M][a]||(p[M][a]=[]),p[M][a].find(e=>e.timestamp==t))||(p[M][a].push({amount:n,avg_buy_price:s,total_value:r,total_buy:c,timestamp:t}),fs.existsSync(d)||fs.writeFileSync(d,"coin,amount,avg_buy_price,total_value,total_buy,timestamp"),fs.appendFileSync(d,`
${a},${n},${s},${r.toFixed(2)},${c},`+t),l[a]||(l[a]=[]),l[a].push({coin:a,amount:n,avg_buy_price:s,total_value:Number(r.toFixed(2)),total_buy:c,timestamp:t}))}),F.on("action",e=>{let{coin:t,type:a,action:i,avg_buy_price:o,income_rate:n,trade_price:s,amount:r,data:{"이동평균":c,RSI:p,MACD:d,"거래량변동":l,ATR:m,"볼린저밴드":u,CCI:_,ADX:w,"피봇포인트":h},timestamp:v}=e;if(M){if(b[M][t]||(b[M][t]=[]),b[M][t].find(e=>e.timestamp==v))return;b[M][t].push({type:a,action:i,avg_buy_price:o,income_rate:n,trade_price:s,amount:r,ma:c,rsi:p,macd:d,cv:l,atr:m,bb:u,cci:_,adx:w,pivot:h,timestamp:v}),fs.existsSync(g)||fs.writeFileSync(g,"coin,type,action,avg_buy_price,income_rate,trade_price,amount,ma,rsi,macd,cv,atr,bb,cci,adx,pivot,timestamp"),fs.appendFileSync(g,`
${t},${a},${i},${o.toFixed(2)},${(100*n).toFixed(2)},${s},${r},${c},${p},${d},${l},${m},${u},${_},${w},${h},`+v),windows.main.webContents.send("action_history",{coin:t,type:a,action:i,avg_buy_price:o,income_rate:n,trade_price:s,amount:r,ma:c,rsi:p,macd:d,cv:l,atr:m,bb:u,cci:_,adx:w,pivot:h,timestamp:v})}windows.main.webContents.send("action",e)}),{});let y=e=>{var t=x[M],a=x[M][e],i=a[a.length-1];let o=[],n=[],s=(Object.values(t).forEach(e=>{0<e.length&&(o.push(e[0]),n.push(e[e.length-1]))}),(new Date).getTime()-864e5),r=(new Date).getTime();var c=F.setting;m={"이동평균":(t=c).score_ma,RSI:t.score_rsi,MACD:t.score_macd,"거래량변동":t.score_cv,"볼린저밴드":t.score_bb,CCI:t.score_cci,ADX:t.score_adx,ATR:t.score_atr,"피봇포인트":Math.max(t.score_pivot,t.score_pivot_r1,t.score_pivot_r2)},t={"이동평균":-t.score_ma,RSI:-t.score_rsi,MACD:-t.score_macd,"거래량변동":-t.score_cv,"볼린저밴드":-t.score_bb,CCI:-t.score_cci,ADX:-t.score_adx,ATR:-t.score_atr,"피봇포인트":Math.min(t.score_pivot,t.score_pivot_s1,t.score_pivot_s2)};let{maxTotalScore:p,minTotalScore:d}={maxTotalScore:Object.values(m).reduce((e,t)=>e+t,0),minTotalScore:Object.values(t).reduce((e,t)=>e+t,0)},l=d3.line().x(e=>(parseInt(e.timestamp)-s)/(r-s)*600).y(e=>300*(1-(parseFloat(e.total_score||0)-d)/(p-d)));var m=a.filter(e=>parseInt(e.timestamp)>s).sort((e,t)=>e.timestamp-t.timestamp).reduce((e,t)=>{var a=new Date(parseInt(t.timestamp)),a=(a.setMinutes(5*Math.floor(a.getMinutes()/5)),a.setSeconds(0),a.setMilliseconds(0),a.getTime());return e[a]||(e[a]=t),e},{}),t=Object.values(m).reduce((e,t,a,i)=>{var o;return 0===a?e.push([t]):(a=e[e.length-1],o=parseInt(a[a.length-1].timestamp),6e5<parseInt(t.timestamp)-o?e.push([t]):a.push(t)),e},[]),a=t.map(e=>l(e)),u=l([{timestamp:s,total_score:0},{timestamp:r,total_score:0}]),_=300*(1-(0-d)/(p-d));let w=c.strategy_manual;switch(c.strategy_type){case"높음":w=c.strategy_high;break;case"중간":w=c.strategy_mid;break;case"낮음":w=c.strategy_low}var h=300*(1-(w-d)/(p-d)),v=l([{timestamp:s,total_score:w},{timestamp:r,total_score:w}]);let b=Math.max(...Object.values(m).map(e=>e.trade_price)),g=Math.min(...Object.values(m).map(e=>e.trade_price)),y=Math.ceil((b-(b+g)/2)/((b+g)/2)*100);y<5&&(y=5);m=(b+g)/2;b=m*(1+y/100),g=m*(1-y/100);let f=d3.line().x(e=>(parseInt(e.timestamp)-s)/(r-s)*600).y(e=>300*(1-(e.trade_price-g)/(b-g)));m=t.map(e=>f(e));windows.main.webContents.send("scoredata",{coin:e,lastscore:i,timestamp:i.timestamp,tradepricepath:m,pathData:a,zeroHeight:_,zeroline:u,buyscore:w,buyHeight:h,buyline:v,tradepricegap:y,minTimestamp:s,maxTimestamp:r,data:t.reduce((e,t)=>e.concat(t),[]),unitsize:288})};F.on("score",t=>{var e,a;x[M]||(x[M]={}),x[M][t.coin]||(x[M][t.coin]=[]),x[M][t.coin].find(e=>e.timestamp==t.timestamp)||(i[t.coin]=path.join(logpath,`fide_score_${M}_${t.coin}.log`),fs.existsSync(i[t.coin])||fs.writeFileSync(i[t.coin],"trade_price,total_buy,income_rate,ma,rsi,macd,cv,atr,bb,cci,adx,pivot,timestamp"),e={total_score:0===parseFloat(t.total_score.toFixed(2))?"0":t.total_score.toFixed(2),ma:0===parseFloat(t.ma.toFixed(2))?"0":t.ma.toFixed(2),rsi:0===parseFloat(t.rsi.toFixed(2))?"0":t.rsi.toFixed(2),macd:0===parseFloat(t.macd.toFixed(2))?"0":t.macd.toFixed(2),cv:0===parseFloat(t.cv.toFixed(2))?"0":t.cv.toFixed(2),atr:0===parseFloat(t.atr.toFixed(2))?"0":t.atr.toFixed(2),bb:0===parseFloat(t.bb.toFixed(2))?"0":t.bb.toFixed(2),cci:0===parseFloat(t.cci.toFixed(2))?"0":t.cci.toFixed(2),adx:0===parseFloat(t.adx.toFixed(2))?"0":t.adx.toFixed(2),pivot:0===parseFloat(t.pivot.toFixed(2))?"0":t.pivot.toFixed(2)},(a=x?.[M]?.[t.coin]?.[x?.[M]?.[t.coin]?.length-1])&&a.trade_price==t.trade_price&&a.total_buy==t.total_buy&&a.income_rate==t.income_rate&&a.ma==e.ma&&a.rsi==e.rsi&&a.macd==e.macd&&a.cv==e.cv&&a.atr==e.atr&&a.bb==e.bb&&a.cci==e.cci&&a.adx==e.adx&&a.pivot==e.pivot)||(fs.appendFileSync(i[t.coin],`
${t.trade_price},${t.total_buy},${0===parseFloat((100*t.income_rate).toFixed(2))?"0":(100*t.income_rate).toFixed(2)},${e.ma},${e.rsi},${e.macd},${e.cv},${e.atr},${e.bb},${e.cci},${e.adx},${e.pivot},${t.timestamp},`+t.total_score),x[M][t.coin].push({...t,...e}),h[t.coin]&&clearTimeout(h[t.coin]),h[t.coin]=setTimeout(()=>{y(t.coin)},1e3))}),F.on("candles",e=>{}),ipcMain.on("run",(e,t)=>{F.run(t),windows.main.webContents.send("run",t)}),ipcMain.on("setting",(e,t)=>{F.updateSetting(t)}),ipcMain.on("update_setting",(e,{key:t,value:a})=>{s&&s.emit("update_setting",{key:t,value:a})}),ipcMain.on("update_setting_diffs",(e,t)=>{s&&s.emit("update_setting_diffs",t)}),ipcMain.on("firstpromotion",(e,t)=>{s&&s.emit("firstpromotion",t)}),ipcMain.on("term",(e,{term:t,version:a,agree:i})=>{s&&s.emit("term",{term:t,version:a,agree:i})}),ipcMain.handle("save_setting",async(e,t)=>{let{promise:a,resolve:i,reject:o}=Promise.withResolvers();return dialog.showSaveDialog(null,{title:"설정 파일 내보내기",buttonLabel:"저장하기",filters:[{name:"json",extensions:["json"]}]}).then(({filePath:e})=>{fs.writeFileSync(e,t,"utf-8"),i(!0)}).catch(e=>{o(e)}),a}),ipcMain.handle("load_setting",async(e,t)=>{let{promise:a,resolve:i,reject:o}=Promise.withResolvers();return dialog.showOpenDialog({title:"설정 파일 불러오기",filters:[{name:"json",extensions:["json"]}],properties:["openFile"]}).then(({filePaths:e})=>{e=fs.readFileSync(e[0],"utf8");i(e)}).catch(e=>{o(e)}),a}),ipcMain.handle("delete_logs",async(e,t)=>{fs.unlinkSync(path.join(logpath,`fide_account_${M}.log`)),fs.unlinkSync(path.join(logpath,`fide_action_${M}.log`));for(var a of fs.readdirSync(logpath))a.includes(`fide_score_${M}_`)&&fs.unlinkSync(path.join(logpath,a))}),ipcMain.handle("open_logs",async(e,t)=>{shell.openPath(logpath)}),ipcMain.on("external_link",(e,t)=>{shell.openExternal(t)});let s;ipcMain.handle("activate_license_token",async(e,t)=>{let{promise:a,resolve:i}=Promise.withResolvers();return s?(s.emit("activate_license_token",t,e=>{i(e)}),a):{type:"error",data:"Socket not connected"}}),ipcMain.handle("auth",async(e,a)=>new Promise((e,t)=>{s?.accessToken==a?e(!0):(s&&s.disconnect(),(s=io(isDev?"http://localhost:8887":"https://app.fide.co.kr:8888",{auth:{token:a},secure:!isDev,rejectUnauthorized:!1})).accessToken=a,s.on("connect_error",e=>{t(!1)}),s.on("connect",()=>{e(!0)}),s.on("version",e=>{windows.main.webContents.send("version",e)}),s.on("terms",e=>{F.terms=e,windows.main.webContents.send("terms",e)}),s.on("preset",e=>{windows.main.webContents.send("preset",e)}),s.on("presets",e=>{windows.main.webContents.send("presets",e)}),s.on("license",e=>{if(e.uid){let v=e.uid;d=path.join(logpath,`fide_account_${v}.log`),fs.existsSync(d)||fs.writeFileSync(d,"coin,amount,avg_buy_price,total_value,total_buy,timestamp");var t=fs.readFileSync(d,"utf8"),t=(p[v]={},t.split("\n").slice(1).forEach(e=>{var[e,t,a,i,o,n]=e.split(",");p[v][e]||(p[v][e]=[]),p[v][e].push({amount:t,avg_buy_price:a,total_value:i,total_buy:o,timestamp:n}),l[e]||(l[e]=[]),l[e].push({coin:e,amount:t,avg_buy_price:a,total_value:i,total_buy:o,timestamp:n})}),g=path.join(logpath,`fide_action_${v}.log`),fs.existsSync(g)||fs.writeFileSync(g,"coin,type,action,avg_buy_price,income_rate,trade_price,amount,ma,rsi,macd,cv,atr,bb,cci,adx,pivot,timestamp"),fs.readFileSync(g,"utf8"));b[v]={},t.split("\n").slice(1).forEach(e=>{var[e,t,a,i,o,n,s,r,c,p,d,l,m,u,_,w,h]=e.split(",");b[v][e]||(b[v][e]=[]),b[v][e].push({type:t,action:a,avg_buy_price:i,income_rate:o,trade_price:n,amount:s,ma:r,rsi:c,macd:p,cv:d,atr:l,bb:m,cci:u,adx:_,pivot:w,timestamp:h}),windows.main.webContents.send("action_history",{coin:e,type:t,action:a,avg_buy_price:i,income_rate:o,trade_price:n,amount:s,ma:r,rsi:c,macd:p,cv:d,atr:l,bb:m,cci:u,adx:_,pivot:w,timestamp:h})});fs.readdirSync(logpath).filter(e=>e.includes(`fide_score_${v}_`)).forEach(e=>{var t=fs.readFileSync(path.join(logpath,e),"utf8");let w=e.split("_")[3].split(".")[0];x[v]||(x[v]={}),t.split("\n").slice(1).forEach(e=>{let[t,a,i,o,n,s,r,c,p,d,l,m,u,_]=e.split(",");x[v][w]||(x[v][w]=[]),isNaN(_)&&(_=0,_=(_=(_=(_=(_=(_=(_=(_=(_+=parseFloat(o||0))+parseFloat(n||0))+parseFloat(s||0))+parseFloat(r||0))+parseFloat(c||0))+parseFloat(p||0))+parseFloat(d||0))+parseFloat(l||0))+parseFloat(m||0)),_=parseFloat(_),x[v][w].push({trade_price:t,total_buy:a,income_rate:i,ma:o,rsi:n,macd:s,cv:r,atr:c,bb:p,cci:d,adx:l,pivot:m,timestamp:u,total_score:_}),h[w]&&clearTimeout(h[w]),h[w]=setTimeout(()=>{y(w)},1e3)})}),M=v}F.license=e,windows.main.webContents.send("license",e)}),s.on("setting",e=>{windows.main.webContents.send("setting",e)}))})),ipcMain.handle("load_setting_preset",async e=>{let{promise:t,resolve:a,reject:i}=Promise.withResolvers();return dialog.showOpenDialog({title:"설정 파일 불러오기",filters:[{name:"json",extensions:["json"]}],properties:["openFile"]}).then(({filePaths:e})=>{var t=fs.readFileSync(e[0],"utf8"),e=e[0].split("/").pop().split("\\").pop().split(".")[0];a({data:t,filename:e})}).catch(e=>{i(e)}),t}),ipcMain.handle("save_setting_preset",async(e,{setting:t,preset:a})=>{let{promise:i,resolve:o,reject:n}=Promise.withResolvers();return s.emit("update_preset",{name:a,setting:t},e=>{if("error"==e.type)return n(e.data);o(e)}),i}),ipcMain.handle("delete_setting_preset",async(e,t)=>{let{promise:a,resolve:i,reject:o}=Promise.withResolvers();return s.emit("delete_preset",{name:t},e=>{if("error"==e.type)return o(e.data);i(e)}),a})},updateready=(autoUpdater.on("checking-for-update",()=>{windows.main.webContents.send("checking-for-update",!0)}),autoUpdater.on("update-available",e=>{windows.main.webContents.send("update-available",e)}),autoUpdater.on("update-not-available",e=>{windows.main.webContents.send("update-not-available",e)}),autoUpdater.on("error",e=>{windows.main.webContents.send("update-error",e)}),autoUpdater.on("download-progress",e=>{windows.main.webContents.send("download-progress",e)}),!1);autoUpdater.on("update-downloaded",e=>{updateready=!0,windows.main.webContents.send("update-downloaded",e)}),ipcMain.handle("check_update",async()=>{isDev?windows.main.webContents.send("update-not-available",{version:"0.0.0"}):(autoUpdater.checkForUpdatesAndNotify(new Notification({title:"Fide",body:"새 버전 다운로드가 완료되었습니다!"})),await new Promise(e=>setTimeout(e,3e3)))}),ipcMain.on("update_install",()=>{if(updateready)autoUpdater.quitAndInstall();else try{app.relaunch({args:process.argv.slice(1).concat(["--relaunch"])}),app.exit(0)}catch(e){console.error("재시작 중 오류 발생:",e),app.exit(1)}}),app.whenReady().then(()=>{protocol.handle("app",e=>net.fetch("file://"+path.join(app.getAppPath(),e.url.slice("app://".length)))),createMainWindow(),autoUpdater.checkForUpdatesAndNotify(new Notification({title:"Fide",body:"새 버전 다운로드가 완료되었습니다!"}))}),app.on("window-all-closed",()=>{"darwin"!==process.platform&&app.quit()}),app.on("activate",()=>{0===BrowserWindow.getAllWindows().length&&createMainWindow()}),app.requestSingleInstanceLock()?app.on("second-instance",(e,t,a)=>{windows.main&&(windows.main.isMinimized()&&windows.main.restore(),windows.main.focus())}):app.quit(),"win32"===process.platform&&app.setAppUserModelId("Fide");