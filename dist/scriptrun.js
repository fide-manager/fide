import _engine from"./engine.js";import{v4 as uuidv4}from"uuid";export default class Runner{constructor(){this.setting={},this.listeners={},this.license={},this.scriptcache={},this.업비트=new _engine({access_key:"",secret_key:""},{ignore:[]}),this.계산={isWithinTimeRange(e,t,a){var i=new Date,i=60*i.getHours()+i.getMinutes(),e=60*e+t,t=e+a;return e<=i&&i<t||1440<=t&&i<t%1440},avg(e){return e.reduce((e,t)=>e+t,0)/e.length},"평균"(e){return this.avg(e)},floor(e,t){return 0<t?Math.floor(e*10**t)/10**t:Math.floor(e)},"내림"(e,t){return this.floor(e,t)},round(e,t){return 0<t?Math.round(e*10**t)/10**t:Math.round(e)},"반올림"(e,t){return this.round(e,t)},ceil(e,t){return 0<t?Math.ceil(e*10**t)/10**t:Math.ceil(e)},"올림"(e,t){return this.ceil(e,t)},getTickSize(e,t,a="ceil"){return 업비트.getTickSize(e,a,t)},"가격틱보정"(e,t,a="올림"){let i;switch(a){case"내림":i="floor";break;case"반올림":i="round";break;default:i="ceil"}return this.getTickSize(e,t,i)}},this.runnings={},this.업비트.on("account",e=>{this.emit("account",e)}),this.업비트.on("candles",e=>{this.emit("candles",e)}),this.업비트.on("updated",async e=>{var{coin:t,rank:a,korean_name:i,trade_price:r}=e.meta,s=this.업비트.coins[t].account?.balance,c=this.업비트.coins[t].account?.locked,n=s+c,o=this.업비트.coins[t].account?.avg_buy_price,_=r*n;if(this.emit("meta",{coin:t,rank:a,korean_name:i,trade_price:r,balance:s,locked:c,total_amount:n,avg_buy_price:o,total_value:_,total_buy:o*n,income_rate:(r-o)/o,isHaving:100<=_,timestamp:(new Date).getTime()}),!this.runnings[e.coin]){this.runnings[e.coin]=(new Date).getTime();try{this.업비트.running&&await this.script(e,!0)&&(await this.업비트.최신화(t),await this.script(e))}catch(e){console.log(e,t)}await this.업비트.sleep(2e3),delete this.runnings[e.coin]}}),this.업비트.on("order",e=>{var t=e.market.replace("KRW-","");this.emit("order",{coin:t,order:e,meta:this.업비트.coins[t].meta,account:this.업비트.coins[t].account,timestamp:(new Date).getTime()})}),this.업비트.on("error",e=>{this.emit("stopped",e)})}async script(i,r){let n=this.업비트;var o=this.계산;let{meta:_,account:h,candles:e,orders:l}=i;i={async sleep(t){return new Promise(e=>setTimeout(e,t))},async"대기"(t){return new Promise(e=>setTimeout(e,t))},async cancelOrders(e){e=await n.cancelOrders(e||await l.대기);return await this.sleep(2e3),e},async"주문취소"(e){return this.cancelOrders(e)},async order(e,t,a,i,r){e=await n.makeOrder(_.티커,e,t,a,i,r);return await this.sleep(2e3),e},async buy_market(e){if(n.가용자금<e)throw new Error(`Not Enough Currency. Usable: ${n.가용자금}, Requested: `+e);return this.order("bid","price",null,e)},async"시장가매수"(e){return this.buy_market(e)},async sell_market(e){if(e)return this.order("ask","market",e,null);throw new Error("Bad Request. Not included volume")},async"시장가매도"(e){return this.sell_market(e)},async sell_limit(e,t,a="ceil"){if(e)return this.order("ask","limit",e,t,a);throw new Error("Bad Request. Not included volume")},async"지정가매도"(e,t,a="올림"){let i;switch(a){case"내림":i="floor";break;case"반올림":i="round";break;default:i="ceil"}return this.sell_limit(e,t,i)}};let m=this.setting,t;switch(m.candle){case"1분":case"3분":case"5분":case"10분":case"15분":case"30분":case"60분":case"240분":case"일":t=parseInt(m.candle.replace("분",""));break;case"일":t="days";break;case"주":t="weeks";break;case"월":t="months";break;default:t=5}var u=e[t];if(!u||!Object.keys(u).length)return!!r||void 0;if((r||!(5e3<new Date-h?.updatedAt))&&(r||!(5e3<new Date-_?.updatedAt))&&(r||!(5e3<new Date-e?.updatedAt))){var d=m.excepted_coins.map(e=>e.split("/")?.[0]),p=l.전체?.[0]||{},p=p.timestamp?new Date(parseInt(p.timestamp)):0;if(!(_.상장개월수<m.exception_months)){let s={},c=(s.단기이동평균_현재=u.이동평균계산(m.candle_start,m.ma_short_count),s.단기이동평균_직전=u.이동평균계산(m.candle_start+m.ma_short_gap,m.ma_short_count),s.단기이동평균_직전전=u.이동평균계산(m.candle_start+m.ma_short_gap+m.ma_short_gap,m.ma_short_count),s.장기이동평균_현재=u.이동평균계산(m.candle_start,m.ma_long_count),s.RSI=u.지수이동평균RSI계산(m.candle_start,m.rsi_count),s.현재MACD=u.MACD계산(m.candle_start),s.이전MACD=u.MACD계산(m.candle_start+m.macd_gap),s.거래량변동=u.최신순[m.candle_start].candle_acc_trade_price/o.평균(u.최신순.slice(m.candle_start,m.candle_start+m.changevolume_count).map(e=>e.candle_acc_trade_price)),s.볼린저밴드=u.볼린저밴드계산(m.candle_start,m.bb_count),s.CCI=u.CCI계산(m.candle_start,m.cci_count),s.ADX=u.ADX계산(m.candle_start,m.adx_count),s.현재ATR=u.ATR계산(m.candle_start,m.atr_count),s.이전ATR=u.ATR계산(m.candle_start+m.atr_gap,m.atr_count),s.피봇포인트=u.피봇포인트계산(m.candle_start,m.pivot_couont),Math.max(s.장기이동평균_현재,.01));var u=Math.max(s.이전ATR,.01),w=s.현재MACD.macd-s.현재MACD.signal,b=Math.max(m.macd_threshold,.1*Math.abs(s.현재MACD.macd)),v=Math.max(s.볼린저밴드.upper-s.볼린저밴드.ma,.01),g=Math.max(s.볼린저밴드.ma-s.볼린저밴드.lower,.01),w={"이동평균":(()=>{var{"단기이동평균_현재":e,"장기이동평균_현재":t,"단기이동평균_직전":a,"단기이동평균_직전전":i}=s,r=0,r=(r=(r=(r+=(t-e)/c*.5)+(e-a)/c*.1)+(a-i)/c*.1)*(10*m.ma_threshold);return Math.max(-1,Math.min(1,r))})(),RSI:s.RSI>100-m.rsi_objective?-(s.RSI-(100-m.rsi_objective))/m.rsi_objective:s.RSI<m.rsi_objective?1:0,MACD:s.현재MACD.macd>s.현재MACD.signal?Math.min(w/b,1):-Math.min(Math.abs(w)/b,1),"거래량변동":0<s.거래량변동?Math.min(s.거래량변동/m.changevolume_objective,1):Math.max(s.거래량변동/m.changevolume_objective,-1),ATR:s.현재ATR>s.이전ATR?(s.현재ATR-s.이전ATR)/u:s.현재ATR<s.이전ATR?-(s.이전ATR-s.현재ATR)/u/2:0,"볼린저밴드":_.현재가격>s.볼린저밴드.upper?-(_.현재가격-s.볼린저밴드.upper)/v:_.현재가격<s.볼린저밴드.lower?(s.볼린저밴드.lower-_.현재가격)/g:0,CCI:100<s.CCI?-1:s.CCI<-100?1:Math.abs(s.CCI)<50?.5:0,ADX:s.ADX.adx>m.adx_threshold?s.ADX.diPlus>s.ADX.diMinus?s.ADX.adx/50:-s.ADX.adx/50:0,"피봇포인트":_.현재가격>s.피봇포인트.pivot?_.현재가격>s.피봇포인트.r1?Math.min((_.현재가격-s.피봇포인트.r1)/(s.피봇포인트.r2-s.피봇포인트.r1),1)*m.score_pivot_r2/100:(_.현재가격-s.피봇포인트.pivot)/(s.피봇포인트.r1-s.피봇포인트.pivot)*m.score_pivot_r1/100:_.현재가격<s.피봇포인트.s1?Math.max((_.현재가격-s.피봇포인트.s1)/(s.피봇포인트.s2-s.피봇포인트.s1),-1)*m.score_pivot_s2/100:(_.현재가격-s.피봇포인트.pivot)/(s.피봇포인트.s1-s.피봇포인트.pivot)*m.score_pivot_s1/100},b=(isNaN(w.피봇포인트)&&(w.피봇포인트=0),{"이동평균":m.score_ma?w.이동평균:0,RSI:m.score_rsi?w.RSI:0,MACD:m.score_macd?w.MACD:0,"거래량변동":m.score_cv?w.거래량변동:0,ATR:m.score_atr?w.ATR:0,"볼린저밴드":m.score_bb?w.볼린저밴드:0,CCI:m.score_cci?w.CCI:0,ADX:m.score_adx?w.ADX:0,"피봇포인트":m.score_pivot||m.score_pivot_r1||m.score_pivot_r2?w.피봇포인트:0});if(m.times_avoid){u=o.isWithinTimeRange(m.times_korea?.hours||0,m.times_korea?.minutes||0,m.times_avoid_time),v=o.isWithinTimeRange(m.times_usa?.hours||0,m.times_usa?.minutes||0,m.times_avoid_time);if(u||v)return}s.지표가중치_상세={"이동평균":b.이동평균*m.score_ma,RSI:b.RSI*m.score_rsi,MACD:b.MACD*m.score_macd,"거래량변동":b.거래량변동*m.score_cv,ATR:b.ATR*m.score_atr,"볼린저밴드":b.볼린저밴드*m.score_bb,CCI:b.CCI*m.score_cci,ADX:b.ADX*m.score_adx,"피봇포인트":b.피봇포인트*m.score_pivot},s.지표가중치_상세={"이동평균":Math.max(Math.min(s.지표가중치_상세.이동평균,m.score_ma),-m.score_ma),RSI:Math.max(Math.min(s.지표가중치_상세.RSI,m.score_rsi),-m.score_rsi),MACD:Math.max(Math.min(s.지표가중치_상세.MACD,m.score_macd),-m.score_macd),"거래량변동":Math.max(Math.min(s.지표가중치_상세.거래량변동,m.score_cv),-m.score_cv),ATR:Math.max(Math.min(s.지표가중치_상세.ATR,m.score_atr),-m.score_atr),"볼린저밴드":Math.max(Math.min(s.지표가중치_상세.볼린저밴드,m.score_bb),-m.score_bb),CCI:Math.max(Math.min(s.지표가중치_상세.CCI,m.score_cci),-m.score_cci),ADX:Math.max(Math.min(s.지표가중치_상세.ADX,m.score_adx),-m.score_adx),"피봇포인트":Math.max(Math.min(s.지표가중치_상세.피봇포인트,Math.max(m.score_pivot,m.score_pivot_r1,m.score_pivot_r2)),-Math.max(m.score_pivot,m.score_pivot_s1,m.score_pivot_s2))},s.지표가중치_상세={"이동평균":Number(s.지표가중치_상세.이동평균.toFixed(2)),RSI:Number(s.지표가중치_상세.RSI.toFixed(2)),MACD:Number(s.지표가중치_상세.MACD.toFixed(2)),"거래량변동":Number(s.지표가중치_상세.거래량변동.toFixed(2)),ATR:Number(s.지표가중치_상세.ATR.toFixed(2)),"볼린저밴드":Number(s.지표가중치_상세.볼린저밴드.toFixed(2)),CCI:Number(s.지표가중치_상세.CCI.toFixed(2)),ADX:Number(s.지표가중치_상세.ADX.toFixed(2)),"피봇포인트":Number(s.지표가중치_상세.피봇포인트.toFixed(2))},s.지표가중치=Object.values(s.지표가중치_상세).reduce((e,t)=>e+t,0),r&&this.emit("score",{coin:_.심볼,total_buy:Math.round(h.총구매가격),trade_price:_.현재가격,income_rate:h.현재수익율,total_score:s.지표가중치,ma:s.지표가중치_상세.이동평균,rsi:s.지표가중치_상세.RSI,macd:s.지표가중치_상세.MACD,cv:s.지표가중치_상세.거래량변동,atr:s.지표가중치_상세.ATR,bb:s.지표가중치_상세.볼린저밴드,cci:s.지표가중치_상세.CCI,adx:b.ADX,pivot:s.지표가중치_상세.피봇포인트,timestamp:Date.now()}),r||console.log("AFT",(new Date).toLocaleString("en-US",{hour12:!1}).split(" ")[1],_.심볼,s.지표가중치,Object.values(s.지표가중치_상세).join(","),h.보유중);g="고정"==m.buy_type?m.buy_amount:n.총자산가치*m.buy_rate/100;let e,t,a;switch(m.strategy_type){case"높음":e=m.strategy_high,t=m.sell_threshold_high,a=m.water_threshold_high;break;case"중간":e=m.strategy_mid,t=m.sell_threshold_mid,a=m.water_threshold_mid;break;case"낮음":e=m.strategy_low,t=m.sell_threshold_low,a=m.water_threshold_low;break;default:e=m.strategy_manual,t=m.sell_threshold,a=m.water_threshold}if(this.scriptcache[_.심볼]||(this.scriptcache[_.심볼]={}),h.보유중){if(!d.includes(_.심볼)){w=h.현재수익율>=m.sell_threshold_objective/100&&s.지표가중치<=t;if("목표 수익율 기반"!=m.sell_type&&w)return!!r||(this.scriptcache[_.심볼].매도판단시점||(this.scriptcache[_.심볼].매도판단시점=Date.now()),void((!parseInt(m.sell_threshold_mins||0)||Date.now()-this.scriptcache[_.심볼].매도판단시점>1e3*parseInt(m.sell_threshold_mins||0)*60)&&(this.scriptcache[_.심볼].매도판단시점=null,await i.주문취소(),this.emit("action",{type:"sell",coin:_.심볼,avg_buy_price:h.avg_buy_price,income_rate:h.현재수익율,trade_price:_.현재가격,amount:h.거래가능보유개수,action:"가중치 기반 매도",data:s.지표가중치_상세,string:`가중치 ${s.지표가중치.toFixed(2)}점, 수익률 ${(100*h.현재수익율).toFixed(2)}%`,timestamp:(new Date).getTime(),uuid:uuidv4()}),await i.시장가매도(h.거래가능보유개수))));if(this.scriptcache[_.심볼]||(this.scriptcache[_.심볼]={}),this.scriptcache[_.심볼].매도판단시점=null,"지표 가중치 기반"==m.sell_type){if(!h.거래가능)return!!r||void await i.주문취소()}else if(h.거래가능)return!!r||void(h.거래가능구매금액>g-100?(o=Math.max(h.평균구매가격*(1+m.water_sell_objective/100),_.현재가격),i.지정가매도(h.거래가능보유개수,o)):(u=Math.max(h.평균구매가격*(1+m.auto_sell_objective/100),_.현재가격),i.지정가매도(h.거래가능보유개수,u)));let e;switch(m.water_calc_type){case"수익율 또는 지표가중치":e=s.지표가중치>=a||h.현재수익율<m.water_start/100;break;case"수익율과 지표가중치":e=s.지표가중치>=a&&h.현재수익율<m.water_start/100;break;case"지표가중치":e=s.지표가중치>=a;break;default:e=h.현재수익율<m.water_start/100}if(m.water){if(Date.now()-p<1e3*parseInt(m.wait_after_water||0)*60)return;if(e){v=l.매수?.[0]?.price||g,b=("마지막 매수금액"==m.water_type?v:h.총구매가격)*m.water_rate/100,w="고정"==m.water_max_type?m.water_max:n.총자산가치*m.water_max_rate/100;if(h.총구매가격+b<w)return!!r||(m.score_calc_time&&(this.scriptcache[_.심볼].투자판단시간||(this.scriptcache[_.심볼].투자판단시간=Date.now()),Date.now()-this.scriptcache[_.심볼].투자판단시간<1e3*parseInt(m.score_calc_time||0)*60)?void 0:(this.scriptcache[_.심볼].투자판단시간=null,await i.주문취소(),await i.시장가매수(b),this.emit("action",{type:"water",coin:_.심볼,avg_buy_price:h.avg_buy_price,income_rate:h.현재수익율,trade_price:_.현재가격,amount:b,action:"물타기",data:s.지표가중치_상세,string:`물타기 총 구매가격 ${h.총구매가격.toLocaleString("ko-KR").split(".")[0]}원, 수익율 ${(100*h.현재수익율).toFixed(2)}%`,timestamp:(new Date).getTime(),uuid:uuidv4()}),"목표 수익율 기반"==m.sell_type&&(o=Math.max(h.평균구매가격*(1+m.water_sell_objective/100),_.현재가격),i.지정가매도(h.거래가능보유개수,o)),void await i.sleep(1e3*parseInt(m.wait_after_water||0)*60)))}else this.scriptcache[_.심볼].투자판단시간=null}if(m.water_exit){u="고정"==m.water_max_type?m.water_max:n.총자산가치*m.water_max_rate/100;if(h.총구매가격>=u&&e){if(r)return!0;await i.주문취소();v=h.거래가능보유개수*h.평균구매가격-h.거래가능보유개수*_.현재가격;this.emit("action",{type:"water_exit",coin:_.심볼,avg_buy_price:h.avg_buy_price,income_rate:h.현재수익율,trade_price:_.현재가격,amount:h.거래가능보유개수,action:"물타기 손절",data:s.지표가중치_상세,string:`손절 손해 ${v.toLocaleString("ko-KR").split(".")[0]}원`,timestamp:(new Date).getTime(),uuid:uuidv4()}),await i.시장가매도(h.거래가능보유개수),await i.sleep(1e3*parseInt(m.wait_after_water||0)*60)}}}}else if(!d.includes(_.심볼)&&!(Date.now()-p<1e3*parseInt(m.wait_after_buy||0)*60||m.strategy_coin_max&&!(n.보유코인개수<m.strategy_coin_max)||m.exception_rank&&!(_.거래량순위<m.exception_rank)||m.exception_warning&&_.투자유의||m.exception_caution&&_.투자주의))if(s.지표가중치>=e){if(r)return!0;m.score_calc_time&&(this.scriptcache[_.심볼].투자판단시간||(this.scriptcache[_.심볼].투자판단시간=Date.now()),Date.now()-this.scriptcache[_.심볼].투자판단시간<1e3*parseInt(m.score_calc_time||0)*60)||(this.scriptcache[_.심볼].투자판단시간=null,await i.주문취소(),await i.시장가매수(g),this.emit("action",{type:"buy",coin:_.심볼,avg_buy_price:h.avg_buy_price,income_rate:h.현재수익율,trade_price:_.현재가격,amount:g,action:"가중치 기반 매수",data:s.지표가중치_상세,string:`가중치 ${s.지표가중치.toFixed(2)}점, ${g.toLocaleString("ko-KR").split(".")[0]}원 매수`,timestamp:(new Date).getTime(),uuid:uuidv4()}),w=Math.max(h.평균구매가격*(1+m.auto_sell_objective/100),_.현재가격),"목표 수익율 기반"==m.sell_type&&(i.지정가매도(h.거래가능보유개수,w),await i.sleep(1e3*parseInt(m.wait_after_buy||0)*60)))}else this.scriptcache[_.심볼].투자판단시간=null}}}sleep(t){return new Promise(e=>setTimeout(()=>e(),t))}updateSetting(e){switch(this.업비트.access_key=e.access_key,this.업비트.secret_key=e.secret_key,this.업비트.key_errored=!1,this.업비트.rankfilter=e.exception_rank,e.candle){case"1분":case"3분":case"5분":case"10분":case"15분":case"30분":case"60분":case"240분":case"일":this.업비트.subscription=[parseInt(e.candle.replace("분","")),"months"];break;case"일":this.업비트.subscription=["days","months"];break;case"주":this.업비트.subscription=["weeks","months"];break;case"월":this.업비트.subscription=["months"]}Object.entries(e).forEach(([e,t])=>{this.setting[e]=t})}emit(e,t){try{this.listeners[e].forEach(async e=>e(t))}catch(e){}}on(e,t){this.listeners[e]||(this.listeners[e]=new Set),this.listeners[e].add(t)}off(e,t){this.listeners[e].delete(t)}validLicense(){var e=(new Date).getTime();return this.license.level&&0<this.license.expire-e}run(e){this.업비트.running=e,this.업비트.key_errored=!1}}